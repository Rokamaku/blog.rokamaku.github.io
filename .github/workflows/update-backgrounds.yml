name: Update Background Images

on:
  push:
    paths:
      - 'public/images/backgrounds/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-backgrounds:
    environment: github-pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Scan background images
        run: node .github/scripts/scan-backgrounds.cjs

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Create wrangler.toml config
        run: |
          cat > wrangler.toml << EOF
          name = "background-uploader"
          account_id = "${{ vars.CLOUDFLARE_ACCOUNT_ID }}"

          [[r2_buckets]]
          binding = "R2_BUCKET"
          bucket_name = "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}"
          EOF

      - name: Configure Wrangler credentials
        run: |
          mkdir -p ~/.wrangler
          echo "${{ secrets.CLOUDFLARE_API_TOKEN }}" > ~/.wrangler/token

      - name: Upload images with Wrangler
        run: |
          # Check if temp directory exists
          if [ ! -d ".tmp-r2-upload" ]; then
            echo "âŒ Error: .tmp-r2-upload directory not found"
            exit 1
          fi

          # Check if index files exist
          if [ ! -f ".tmp-r2-upload/light-index.json" ] || [ ! -f ".tmp-r2-upload/dark-index.json" ]; then
            echo "âŒ Error: Index files not found in .tmp-r2-upload directory"
            exit 1
          fi

          # Upload light mode images
          echo "ðŸ“¤ Uploading light mode images..."
          for file in public/images/backgrounds/light/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              wrangler r2 object put "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}/backgrounds/light/$filename" --file "$file" --content-type "$(file --mime-type -b "$file")"
              echo "  Uploaded: $filename"
            fi
          done

          # Upload dark mode images
          echo "ðŸ“¤ Uploading dark mode images..."
          for file in public/images/backgrounds/dark/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              wrangler r2 object put "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}/backgrounds/dark/$filename" --file "$file" --content-type "$(file --mime-type -b "$file")"
              echo "  Uploaded: $filename"
            fi
          done

          # Upload index.json files
          echo "ðŸ“¤ Uploading index.json files..."
          wrangler r2 object put "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}/backgrounds/light/index.json" --file ".tmp-r2-upload/light-index.json" --content-type "application/json"
          echo "  Uploaded: light/index.json"

          wrangler r2 object put "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}/backgrounds/dark/index.json" --file ".tmp-r2-upload/dark-index.json" --content-type "application/json"
          echo "  Uploaded: dark/index.json"

          # Create and upload the main index file
          echo "ðŸ“¤ Creating and uploading main index.json..."
          cat > ".tmp-r2-upload/main-index.json" << EOF
          {
            "modes": ["light", "dark"],
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

          wrangler r2 object put "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}/backgrounds/index.json" --file ".tmp-r2-upload/main-index.json" --content-type "application/json"
          echo "  Uploaded: backgrounds/index.json"

          echo "âœ… All background images and index files uploaded to Cloudflare R2"

      - name: Display URL information
        run: |
          echo "âœ… Background images successfully uploaded to R2"
          if [ -n "${{ vars.CLOUDFLARE_DOMAIN }}" ]; then
            echo "ðŸ“‹ Images are available at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/light/"
            echo "ðŸ“‹ Light index file is at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/light/index.json"
            echo "ðŸ“‹ Dark index file is at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/dark/index.json"
            echo "ðŸ“‹ Main index file is at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/index.json"
          else
            echo "ðŸ“‹ Images are available at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/light/"
            echo "ðŸ“‹ Light index file is at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/light/index.json"
            echo "ðŸ“‹ Dark index file is at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/dark/index.json"
            echo "ðŸ“‹ Main index file is at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/index.json"
          fi

      - name: Purge Cloudflare Cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ vars.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_EMAIL: ${{ vars.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_DOMAIN: ${{ vars.CLOUDFLARE_DOMAIN }}
        run: |
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_DOMAIN" ]; then
            echo "Skipping cache purge - Required Cloudflare variables not set"
            exit 0
          fi

          # Create a temporary JSON file for the purge request with background file URLs
          cat > purge-cache.json << EOF
          {
            "files": [
              "https://$CLOUDFLARE_DOMAIN/backgrounds/light/index.json",
              "https://$CLOUDFLARE_DOMAIN/backgrounds/dark/index.json",
              "https://$CLOUDFLARE_DOMAIN/backgrounds/index.json"
            ]
          }
          EOF

          # Make the API call to purge the cache
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data @purge-cache.json

          echo "âœ… Cache purge requested for background files"
