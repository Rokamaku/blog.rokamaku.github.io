name: Update Background Images

on:
  push:
    paths:
      - 'public/images/backgrounds/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-backgrounds:
    environment: github-pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: yarn

      - name: Scan background images
        run: node .github/scripts/scan-backgrounds.cjs

      - name: Debug temp directory
        run: |
          echo "Debugging .tmp-r2-upload directory:"
          if [ -d ".tmp-r2-upload" ]; then
            echo "Directory exists"
            ls -la .tmp-r2-upload
          else
            echo "Directory does not exist!"
            mkdir -p .tmp-r2-upload
            echo "Created directory"
          fi

      - name: Install dependencies
        run: yarn add wrangler@latest --dev

      - name: Setup Cloudflare credentials
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Create a .env file for Wrangler to use
          echo "CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN" > .env
          echo "CLOUDFLARE_ACCOUNT_ID=$CLOUDFLARE_ACCOUNT_ID" >> .env

          # Create wrangler.toml config file
          cat > wrangler.toml << EOF
          name = "background-uploader"
          account_id = "${{ vars.CLOUDFLARE_ACCOUNT_ID }}"

          [[r2_buckets]]
          binding = "R2_BUCKET"
          bucket_name = "${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}"
          EOF

      - name: Upload images to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}
        run: |
          # Ensure the temp directory exists
          mkdir -p .tmp-r2-upload

          # Create index files if they don't exist (backup logic)
          if [ ! -f ".tmp-r2-upload/light-index.json" ]; then
            echo "Light index file missing, creating backup..."
            LIGHT_IMAGES=$(ls -1 public/images/backgrounds/light | grep -E '.(jpg|jpeg|png|webp|avif)$' | jq -R -s 'split("\n") | map(select(length > 0))')
            echo "{\"images\": $LIGHT_IMAGES, \"lastUpdated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > .tmp-r2-upload/light-index.json
          fi

          if [ ! -f ".tmp-r2-upload/dark-index.json" ]; then
            echo "Dark index file missing, creating backup..."
            DARK_IMAGES=$(ls -1 public/images/backgrounds/dark | grep -E '.(jpg|jpeg|png|webp|avif)$' | jq -R -s 'split("\n") | map(select(length > 0))')
            echo "{\"images\": $DARK_IMAGES, \"lastUpdated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > .tmp-r2-upload/dark-index.json
          fi

          # Create main index file
          echo "{\"modes\": [\"light\", \"dark\"], \"lastUpdated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > .tmp-r2-upload/main-index.json

          # Debug - Show index files
          echo "Index files content:"
          cat .tmp-r2-upload/light-index.json
          cat .tmp-r2-upload/dark-index.json
          cat .tmp-r2-upload/main-index.json

          # Upload light mode images
          echo "ðŸ“¤ Uploading light mode images..."
          for file in public/images/backgrounds/light/*; do
            if [ -f "$file" ] && [[ "$file" =~ \.(jpg|jpeg|png|webp|avif)$ ]]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              yarn wrangler r2 object put "$R2_BUCKET/backgrounds/light/$filename" --file "$file" --content-type "$(file --mime-type -b "$file")" --remote || echo "Failed to upload $filename"
            fi
          done

          # Upload dark mode images
          echo "ðŸ“¤ Uploading dark mode images..."
          for file in public/images/backgrounds/dark/*; do
            if [ -f "$file" ] && [[ "$file" =~ \.(jpg|jpeg|png|webp|avif)$ ]]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              yarn wrangler r2 object put "$R2_BUCKET/backgrounds/dark/$filename" --file "$file" --content-type "$(file --mime-type -b "$file")" --remote || echo "Failed to upload $filename"
            fi
          done

          # Upload index files
          echo "ðŸ“¤ Uploading index.json files..."
          yarn wrangler r2 object put "$R2_BUCKET/backgrounds/light/index.json" --file ".tmp-r2-upload/light-index.json" --content-type "application/json" --remote || echo "Failed to upload light index"
          echo "  Uploaded: light/index.json"

          yarn wrangler r2 object put "$R2_BUCKET/backgrounds/dark/index.json" --file ".tmp-r2-upload/dark-index.json" --content-type "application/json" --remote || echo "Failed to upload dark index"
          echo "  Uploaded: dark/index.json"

          yarn wrangler r2 object put "$R2_BUCKET/backgrounds/index.json" --file ".tmp-r2-upload/main-index.json" --content-type "application/json" --remote || echo "Failed to upload main index"
          echo "  Uploaded: backgrounds/index.json"

          echo "âœ… Uploads to Cloudflare R2 completed"

      - name: Display URL information
        run: |
          echo "âœ… Background images processing completed"
          if [ -n "${{ vars.CLOUDFLARE_DOMAIN }}" ]; then
            echo "ðŸ“‹ Images should be available at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/light/"
            echo "ðŸ“‹ Light index file at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/light/index.json"
            echo "ðŸ“‹ Dark index file at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/dark/index.json"
            echo "ðŸ“‹ Main index file at: https://${{ vars.CLOUDFLARE_DOMAIN }}/backgrounds/index.json"
          else
            echo "ðŸ“‹ Images should be available at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/light/"
            echo "ðŸ“‹ Light index file at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/light/index.json"
            echo "ðŸ“‹ Dark index file at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/dark/index.json"
            echo "ðŸ“‹ Main index file at: https://${{ vars.CLOUDFLARE_R2_BUCKET_NAME }}.${{ vars.CLOUDFLARE_ACCOUNT_ID }}.r2.dev/backgrounds/index.json"
          fi

      - name: Purge Cloudflare Cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ vars.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_DOMAIN: ${{ vars.CLOUDFLARE_DOMAIN }}
        run: |
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_DOMAIN" ]; then
            echo "Skipping cache purge - Required Cloudflare variables not set"
            exit 0
          fi

          # Create a temporary JSON file for the purge request
          cat > purge-cache.json << EOF
          {
            "files": [
              "https://$CLOUDFLARE_DOMAIN/backgrounds/light/index.json",
              "https://$CLOUDFLARE_DOMAIN/backgrounds/dark/index.json",
              "https://$CLOUDFLARE_DOMAIN/backgrounds/index.json"
            ]
          }
          EOF

          # Make the API call to purge the cache
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data @purge-cache.json

          echo "âœ… Cache purge requested for background files"
